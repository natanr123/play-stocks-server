"use strict";
import AlphaVantageService from 'app/service/AlphaVantageService';
import AlphaVantageServiceStub from 'test/stubs/AlphaVantageServiceStub';
import TimeUtilsStub from 'test/stubs/TimeUtilsStub'

import StocksSymbols from 'app/service/StocksSymbols';

import MarketTime from 'app/entity/MarketTime'
import assert from 'assert';
import StocksHistory from 'app/repository/StocksHistory'
import sinon from 'sinon';
import AlphaStocksManager from 'app/stocks/AlphaStocksManager'
import TimeUtils from 'app/service/TimeUtils'



    process.on('unhandledRejection', error => {
    // Won't execute
    console.log('unhandledRejection22222', error);
});

//
describe('StocksHistory', function() {
    AlphaVantageServiceStub.start();
    TimeUtilsStub.start();

    this.timeout(2000);


    // it('createCompareMethod', ()=>
    // {
    //     let compareCallback = StocksHistory.createCompareMethod(10);
    //     let r = 0;
    //     r = compareCallback({time:6},{time:3});
    //     assert.equal(r, -1);
    //     r = compareCallback({time:3},{time:6});
    //     assert.equal(r, 1);
    //     r = compareCallback({time:13},{time:16});
    //     assert.equal(r, -1);
    //     r = compareCallback({time:16},{time:13});
    //     assert.equal(r, 1);
    //     r = compareCallback({time:7},{time:16});
    //     assert.equal(r, -1);
    //     r = compareCallback({time:16},{time:7});
    //     assert.equal(r, 1);
    //     r = compareCallback({time:10},{time:11});
    //     assert.equal(r, -1);
    //     r = compareCallback({time:11},{time:10});
    //     assert.equal(r, 1);
    //     r = compareCallback({time:11},{time:11});
    //     assert.equal(r, 0);
    // });
    //
    // it('sort by nearest time', (done)=>
    // {
    //     AlphaVantageService.info(StocksSymbols.MSFT).then((response)=> {
    //         AlphaStocksManager.getInstance().start(100,1).then(()=>{
    //             assert.equal(StocksHistory.getInstance().histories[StocksSymbols.MSFT].length, 100);
    //             let lines = StocksHistory.getInstance().histories[StocksSymbols.MSFT];
    //
    //             let sortedLines = StocksHistory.sortByNearestTime(1498242960,lines);
    //             assert.equal(sortedLines[0].time, 1498242960);
    //             done();
    //         });
    //
    //     });
    // });
    //
    // it('nearest', (done)=>
    // {
    //     AlphaVantageService.info(StocksSymbols.MSFT).then((response)=> {
    //         AlphaStocksManager.getInstance().start(100,1).then(()=>{
    //             assert.equal(StocksHistory.getInstance().histories[StocksSymbols.MSFT].length, 100);
    //             let nearest = StocksHistory.getInstance().nearest(StocksSymbols.MSFT,1498242960);
    //             assert.equal(nearest.time, 1498242960);
    //             done();
    //         });
    //
    //     });
    // });
    //
    // it('find simple', (done)=>
    // {
    //         AlphaStocksManager.getInstance().start(100,1).then(()=>{
    //             let found;
    //             assert.equal(StocksHistory.getInstance().histories[StocksSymbols.MSFT].length, 100);
    //
    //             found = StocksHistory.getInstance().find(StocksSymbols.MSFT, 1498242960);
    //             assert.equal(found === null, false);
    //             assert.equal(found.time, 1498242960);
    //             found = StocksHistory.getInstance().find(StocksSymbols.MSFT, 1498242963,1);
    //             assert.equal(found, null );
    //
    //             done();
    //         });
    // });

    //
    //
    // // getLastsBySteps(symbol,baseTime,count,step)
    // it('getLastsBySteps', (done)=>
    // {
    //     AlphaVantageService.info(StocksSymbols.MSFT).then((response)=> {
    //         AlphaStocksManager.getInstance().start(100,1).then(()=>{
    //             let found;
    //             assert.equal(StocksHistory.getInstance().histories[StocksSymbols.MSFT].length, 100);
    //
    //             let baseTime = 1498242960;
    //             let date = new Date(baseTime*1000);
    //             assert.equal(TimeUtils.timeInNewYork(date),'2017-06-23 14:36:00');
    //
    //             let last6Arr = StocksHistory.getInstance().getLastsBySteps(StocksSymbols.MSFT,baseTime,6,60*5);
    //             assert.equal(last6Arr.length, 6);
    //             let lastLine = StocksHistory.getInstance().lastLine(StocksSymbols.MSFT);
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[0].time*1000),'2017-06-23 14:36:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[1].time*1000),'2017-06-23 14:31:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[2].time*1000),'2017-06-23 14:26:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[3].time*1000),'2017-06-23 14:21:00');
    //             assert.equal(TimeUtils.timeInNewYork(lastLine.time*1000),'2017-06-23 14:21:00');
    //             assert.equal(last6Arr[4],null);
    //             assert.equal(last6Arr[5],null);
    //             done();
    //         });
    //
    //     });
    // });
    //
    // // getLastsBySteps(symbol,baseTime,count,step)
    // it('last6by5Old', (done)=>
    // {
    //         AlphaStocksManager.getInstance().start(100,1).then(()=>{
    //             let found;
    //             assert.equal(StocksHistory.getInstance().histories[StocksSymbols.MSFT].length, 100);
    //
    //             let baseTime = 1498242960;
    //             let date = new Date(baseTime*1000);
    //             assert.equal(TimeUtils.timeInNewYork(date),'2017-06-23 14:36:00');
    //
    //             let last6Arr = StocksHistory.getInstance().last6by5(StocksSymbols.MSFT,baseTime);
    //             assert.equal(last6Arr.length, 6);
    //             let lastLine = StocksHistory.getInstance().lastLine(StocksSymbols.MSFT);
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[0].time*1000),'2017-06-23 14:36:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[1].time*1000),'2017-06-23 14:31:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[2].time*1000),'2017-06-23 14:26:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[3].time*1000),'2017-06-23 14:21:00');
    //             assert.equal(TimeUtils.timeInNewYork(lastLine.time*1000),'2017-06-23 14:21:00');
    //             assert.equal(last6Arr[4],null);
    //             assert.equal(last6Arr[5],null);
    //             done();
    //         });
    //
    // });

    // it('verifyLast6By5', (done)=>
    // {
    //         AlphaStocksManager.getInstance().start(100,1).then(()=>{
    //             let found;
    //             assert.equal(StocksHistory.getInstance().histories[StocksSymbols.MSFT].length, 100);
    //             console.log('StocksHistory.getInstance().histories[StocksSymbols.MSFT]: ',StocksHistory.getInstance().histories[StocksSymbols.MSFT]);
    //             let baseTime = 1498242960;
    //             let date = new Date(baseTime*1000);
    //             assert.equal(TimeUtils.timeInNewYork(date),'2017-06-23 14:36:00');
    //
    //             let last6Arr = StocksHistory.getInstance().last6by5(StocksSymbols.MSFT,baseTime);
    //             assert.equal(last6Arr.length, 6);
    //             console.log('last6Arr: ',last6Arr);
    //             let lastLine = StocksHistory.getInstance().lastLine(StocksSymbols.MSFT);
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[0].time*1000),'2017-06-23 14:36:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[1].time*1000),'2017-06-23 14:31:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[2].time*1000),'2017-06-23 14:26:00');
    //             assert.equal(TimeUtils.timeInNewYork(last6Arr[3].time*1000),'2017-06-23 14:21:00');
    //             assert.equal(TimeUtils.timeInNewYork(lastLine.time*1000),'2017-06-23 14:21:00');
    //             assert.equal(last6Arr[4],null);
    //             assert.equal(last6Arr[5],null);
    //             done();
    //         });
    // });

    it('verifyTimeSync no exception', (done)=>
    {
            AlphaStocksManager.getInstance().start(100,1).then(()=>{
                let baseTime = 1498248000;
                StocksHistory.getInstance().verifyTimeSync(StocksSymbols.MSFT,baseTime);
                baseTime = 1498248000+StocksHistory.STOCK_SEARCH_ACCURACY;
                StocksHistory.getInstance().verifyTimeSync(StocksSymbols.MSFT,baseTime);
                baseTime = 1498248000-StocksHistory.STOCK_SEARCH_ACCURACY;
                StocksHistory.getInstance().verifyTimeSync(StocksSymbols.MSFT,baseTime);
                done();
            });
    });

    it('last6by5', (done)=>
    {
        AlphaStocksManager.getInstance().start(100,1).then(()=>{
            let lines = StocksHistory.getInstance().last6by5(StocksSymbols.MSFT,1498248000);
            //console.log('lines: ',lines);
            assert.equal(lines.length,6);
            done();
        });
    });



});