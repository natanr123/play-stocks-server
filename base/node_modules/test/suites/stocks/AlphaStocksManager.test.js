"use strict";
import assert from 'assert';
import AlphaVantageService from 'app/service/AlphaVantageService';
import AlphaVantageServiceStub from 'test/stubs/AlphaVantageServiceStub';

import StocksSymbols from 'app/service/StocksSymbols';

import AlphaStocksManager from 'app/stocks/AlphaStocksManager';
import TimeUtils from 'app/service/TimeUtils';
import StocksHistory from 'app/repository/StocksHistory';

import sinon from 'sinon';

process.on('unhandledRejection', error => {
    // Won't execute
    console.log('unhandledRejection22222', error);
});

//
describe('AlphaStocksManager', function() {
    AlphaVantageServiceStub.start();
    this.timeout(2000);

    it('processTime should give utc in seconds time based on America/New_York time', ()=>
    {
        let newYorkTime = '2017-06-23 16:00:00';
        let utcTime = AlphaStocksManager.getInstance().processTime(newYorkTime);
        console.log('utcTime: ',utcTime);

        let date = new Date(utcTime*1000);
        assert.equal(TimeUtils.timeInNewYork(date),'2017-06-23 16:00:00');
        assert.equal(utcTime, 1498248000);
    });

    it('processResponse get history lines array', (done)=>
    {
        AlphaVantageService.info(StocksSymbols.MSFT).then((response)=> {
            let lines = AlphaStocksManager.getInstance().processResponse(StocksSymbols.MSFT, response);
            assert.equal(lines.length, 100);
            done();
        });

    });

    it('processResponse verify lines', (done)=>
    {
        AlphaVantageService.info(StocksSymbols.MSFT).then((response)=> {
            let lines = AlphaStocksManager.getInstance().processResponse(StocksSymbols.MSFT, response);
            assert.equal(lines.length, 100);
            let verifiedLinesCounter = AlphaStocksManager.verifyData(lines);
            assert.equal(verifiedLinesCounter, 99);
            done();
        });

    });

    it('Verify lines between days', ()=>
    {
        let lines = AlphaVantageServiceStub.linesFromDifferentDays();
        assert.equal(lines.length, 100);
        let verifiedLinesCounter = AlphaStocksManager.verifyData(lines);
        assert.equal(verifiedLinesCounter, 98);
    });


});

