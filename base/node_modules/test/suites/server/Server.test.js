"use strict";
import chai from 'chai'
import chaiHttp from 'chai-http';

import TimeUtilsStub from 'test/stubs/TimeUtilsStub';
import IntrinioStocksHistoryRepositoryStub from 'test/stubs/IntrinioStocksHistoryRepositoryStub'

import MyDB from 'app/MyDB'
import Entity from 'app/entity/Entity'

import Server from 'app/Server'
import IntrinioStocksHistoryRepository from 'app/repository/IntrinioStocksHistoryRepository'

// https://scotch.io/tutorials/test-a-node-restful-api-with-mocha-and-chai


chai.use(chaiHttp);
let server = new Server();
server.start();
process.on('unhandledRejection', error => {
    // Won't execute
    console.log('unhandledRejection22222', error);
});

// Problematic
describe('Server', function() {
    TimeUtilsStub.stop();


    it('/createOrder', (done)=> {
        resetDB();
        IntrinioStocksHistoryRepositoryStub.fillSomeData();
        chai.request('http://localhost:3000')
            .get('/accounts/create')
            .query({balance: 1000000})
            .then( (res) => {
                let obj = JSON.parse(res.text);
                console.log(obj);
                done()})


    });

    function resetDB() {
        MyDB.getInstance().clear();
        Entity.reset();
        IntrinioStocksHistoryRepository.getInstance().countCache = 0;
    }




});